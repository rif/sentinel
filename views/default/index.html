{{extend 'layout.html'}}

<div id="placeholder"></div>

<ul id="servers">
    <li><a class="edit-link" href="{{=URL('server')}}">{{=T('Add new')}}</a></li>
{{for s in servers:}}
<li>
  <a href="{{=URL('reports', args=s.id)}}">{{=s.address}}</a>
  <a class="undercover edit-link" href="{{=URL('server', args=s.id)}}">{{=T('Edit')}}</a>
  <a class="undercover delete-link" href="{{=URL('server_remove', args=s.id)}}">{{=T('Remove')}}</a>
</li>
{{pass}}
</ul>

<div id="report">
{{=form}}
<center>
    <div id="chart-container-1" style="width: 60%"></div>
</center>
</div>

<script type="text/javascript" src="{{=URL('static','js/highcharts.js')}}"></script>
<script type="text/javascript" src="{{=URL('static','js/themes/grid.js')}}"></script>

<script type="text/javascript">
  var chart1; // globally available
    $(document).ready(function() {
	chart1 = new Highcharts.Chart({
            chart: {
		renderTo: 'chart-container-1',
		defaultSeriesType: 'line'
            },
            title: {
		text: 'Fruit Consumption'
            },
            xAxis: {
		categories: ['Apples', 'Bananas', 'Oranges']
            },
            yAxis: {
		title: {
		    text: 'Fruit eaten'
		}
            },
            series: [{
		name: 'Jane',
		data: [1, 0, 4]
            }, {
		name: 'John',
		data: [5, 7, 3]
            }]
	});
    });

    function prepareForm(link){
	var href = link.attr("href");
	$("form").submit(function(){
	    $.post(href, $(this).serialize(), function(data){
		if(data.indexOf("error") == -1){
		    if($(".editing").length != 0) { // we have elements in editing state
			$(".editing").parent().replaceWith(data);
		    } else {
			link.parents('ul').append(data); 
		    }
		    $("#placeholder").slideUp();
		    setup();
		} else {
		    $("#placeholder").html(data);
		    prepareForm(link);
		}
	    });
	    return false;
	});
    }
function setup(){
    $(".edit-link").unbind();
    $("#servers li").unbind();
    $(".delete-link").unbind();
    $(".edit-link").click(function(e){    
	var link = $(this);
	$(".editing").removeClass("editing");
	link.prev("a").addClass("editing");
	$("#placeholder").load($(this).attr("href"), function(){
	    $(this).slideDown();
	    prepareForm(link);
	});
	e.preventDefault();
    });
    $(".delete-link").click(function(e){
	if(confirm("{{=T('Are you shure you want to delete this server? Deleting it will erase all readings related to it!')}}")) {
	    $(this).parents("li:first").remove();
	    $.get($(this).attr("href"));
	}
	e.preventDefault();
    });
    
    $("#servers li").mouseover(function(){
	$(this).children("a.undercover").fadeIn();
    }).mouseleave(function(){
	$(this).children("a.undercover").fadeOut();
    });
    
}
$(function(){
    setup();
});
</script>